

<section
  class="product-recommendations"
  data-section-id="product-recomendations"
  data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit=4"
>
  {%- if recommendations.performed and recommendations.products_count > 0 -%}
  <div class="gc">
    <div class="d-1-4 m-1-13 max-width-350">
      {% if section.settings.recommended_products_title != blank %}
        {% include 'heading', text: section.settings.recommended_products_title %}
      {% endif %}
    </div>
    {% for product in recommendations.products %}
      {% if forloop.index <= section.settings.recommended_products_count %}
        {% include 'product-card', 
          product: product,
          context: section.id 
        %}
      {% endif %}
    {% endfor %}
  </div>
  {%- endif -%}
</section>

{% javascript %}
  const handleIntersection = (entries, observer) => {
    if (!entries[0].isIntersecting) return;

    observer.unobserve(productRecommendationsSection);

    const url = productRecommendationsSection.dataset.url;

    fetch(url)
      .then(response => response.text())
      .then(text => {
        const html = document.createElement('div');
        html.innerHTML = text;
        const recommendations = html.querySelector('.product-recommendations');
        recommendations.innerHTML = text;
        if (recommendations && recommendations.innerHTML.trim().length) {
          productRecommendationsSection.innerHTML = recommendations.innerHTML;
          // Fire lazyload for async images
          var lazyLoadInstance = new LazyLoad({
            elements_selector: "img"
          });
        }
      })
      .catch(e => {
        console.error(e);
      });
  };

  const productRecommendationsSection = document.querySelector('.product-recommendations');
  const observer = new IntersectionObserver(handleIntersection, {rootMargin: '0px 0px 200px 0px'});

  observer.observe(productRecommendationsSection);
{% endjavascript %}

{% schema %}
  {
    "name": "Product recommendations",
    "settings": [
      {
        "type": "textarea",
        "id": "recommended_products_title",
        "label": "Title",
        "default": "Other Products we think you might like"
      },
      {
        "type": "range",
        "id": "recommended_products_count",
        "label": "Recommended products count",
        "min": 1,
        "max": 4,
        "step": 1,
        "default": 3
      }
    ]
  }
{% endschema %}
